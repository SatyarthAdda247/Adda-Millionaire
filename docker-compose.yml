version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: millionaires-backend
    ports:
      - "8080:8080"  # Frontend (matches dev port 8080)
      - "3001:3001"  # Backend API (matches dev port 3001)
    environment:
      # AWS
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      
      # DynamoDB
      - DYNAMODB_USERS_TABLE=${DYNAMODB_USERS_TABLE}
      - DYNAMODB_LINKS_TABLE=${DYNAMODB_LINKS_TABLE}
      - DYNAMODB_ANALYTICS_TABLE=${DYNAMODB_ANALYTICS_TABLE}
      
      # AppTrove API
      - APPTROVE_API_URL=${APPTROVE_API_URL}
      - APPTROVE_API_KEY=${APPTROVE_API_KEY}
      - APPTROVE_SECRET_ID=${APPTROVE_SECRET_ID}
      - APPTROVE_SECRET_KEY=${APPTROVE_SECRET_KEY}
      - APPTROVE_SDK_KEY=${APPTROVE_SDK_KEY}
      - APPTROVE_REPORTING_API_KEY=${APPTROVE_REPORTING_API_KEY}
      - APPTROVE_DOMAIN=${APPTROVE_DOMAIN}
      
      # AppTrove Dashboard (for automation)
      - APPTROVE_DASHBOARD_EMAIL=${APPTROVE_DASHBOARD_EMAIL}
      - APPTROVE_DASHBOARD_PASSWORD=${APPTROVE_DASHBOARD_PASSWORD}
      
      # Server
      - PORT=8000
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
